#!/usr/bin/env bash

VERSION="1.0.0"
BIRTHDATE=""
MODE="full"

show_help() {
  echo "Usage: agecalc -b YYYY-MM-DD [options]"
  echo ""
  echo "Options:"
  echo "  -b, --birthdate <date>   Birthdate in YYYY-MM-DD format"
  echo "  -y, --years-only         Show only the age in years"
  echo "  -d, --days-lived         Show total number of days lived"
  echo "  -u, --until-birthday     Show days until next birthday"
  echo "  -f, --full-info          Show full age details"
  echo "  -h, --help               Show help message"
  echo "  -v, --version            Show version"
}

validate_date() {
  if [[ ! $1 =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
    echo "Invalid birthdate format. Use YYYY-MM-DD."
    exit 1
  fi
}

calculate_age() {
  local birth="$1"
  local today
  today=$(date +%Y-%m-%d)

  local by bm bd
  by=$(date -jf "%Y-%m-%d" "$birth" +%Y)
  bm=$(date -jf "%Y-%m-%d" "$birth" +%m)
  bd=$(date -jf "%Y-%m-%d" "$birth" +%d)

  local ty tm td
  ty=$(date +%Y)
  tm=$(date +%m)
  td=$(date +%d)

years=$((10#$ty - 10#$by))
months=$((10#$tm - 10#$bm))
days=$((10#$td - 10#$bd))

  if ((days < 0)); then
    months=$((months - 1))
    days=$((days + 30))
  fi

  if ((months < 0)); then
    years=$((years - 1))
    months=$((months + 12))
  fi

  total_days=$(( ($(date -jf "%Y-%m-%d" "$today" +%s) - $(date -jf "%Y-%m-%d" "$birth" +%s)) / 86400 ))

  next_birthday=$(date -jf "%Y-%m-%d" "${ty}-${bm}-${bd}" +%s 2>/dev/null)
  if (( $(date +%s) > next_birthday )); then
    next_birthday=$(date -jf "%Y-%m-%d" "$((ty+1))-${bm}-${bd}" +%s 2>/dev/null)
  fi

  days_to_bday=$(( (next_birthday - $(date +%s)) / 86400 ))
}

if [[ $# -eq 0 ]]; then
  show_help
  exit 0
fi

while [[ $# -gt 0 ]]; do
  case "$1" in
    -b|--birthdate)
      BIRTHDATE="$2"
      validate_date "$BIRTHDATE"
      shift 2 ;;
    -y|--years-only)
      MODE="years"
      shift ;;
    -d|--days-lived)
      MODE="days"
      shift ;;
    -u|--until-birthday)
      MODE="until"
      shift ;;
    -f|--full-info)
      MODE="full"
      shift ;;
    -h|--help)
      show_help
      exit 0 ;;
    -v|--version)
      echo "agecalc version $VERSION"
      exit 0 ;;
    *)
      echo "Unknown option: $1"
      show_help
      exit 1 ;;
  esac
done

if [[ -z "$BIRTHDATE" ]]; then
  echo "Error: Birthdate is required. Use -b YYYY-MM-DD"
  exit 1
fi

calculate_age "$BIRTHDATE"

case "$MODE" in
  years)
    echo "You are $years years old"
    ;;
  days)
    echo "You have lived $total_days days"
    ;;
  until)
    echo "Days until your next birthday: $days_to_bday days"
    ;;
full)
    echo "════════════════════════════════════"
    echo "           Age Calculator"
    echo "════════════════════════════════════"
    echo ""
    printf "%-22s %s\n" "Birthdate:" "$BIRTHDATE"
    printf "%-22s %s\n" "Today:" "$(date +%Y-%m-%d)"
    echo ""
    printf "%-22s %s years, %s months, %s days\n" "Age:" "$years" "$months" "$days"
    printf "%-22s %s days\n" "Total Days Lived:" "$total_days"
    printf "%-22s %s days\n" "Days Until Birthday:" "$days_to_bday"
    echo ""
    echo "════════════════════════════════════"
    ;;



esac

exit 0
